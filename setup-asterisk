#!/bin/bash

ASTERISK_USERS_CONF_USERBASE=6000
ASTERISK_DIALPLAN_USERS='6XXX'
CURRENT_EXTENSION_NUM=${ASTERISK_USERS_CONF_USERBASE}
CONFIGURED_EXTENSIONS=()
ASK_TO_REBOOT=0
RASPBERRY_IP_ADDRESS=''

calc_wt_size() {
    # NOTE: it's tempting to redirect stderr to /dev/null, so supress error 
    # output from tput. However in this case, tput detects neither stdout or 
    # stderr is a tty and so only gives default 80, 24 values
    WT_HEIGHT=17
    WT_WIDTH=$(tput cols)

    if [ -z "$WT_WIDTH" ] || [ "$WT_WIDTH" -lt 60 ]; then
        WT_WIDTH=80
    fi
    if [ "$WT_WIDTH" -gt 178 ]; then
        WT_WIDTH=120
    fi
    WT_MENU_HEIGHT=$(($WT_HEIGHT-7))
}

do_expand_rootfs() {
    if ! [ -h /dev/root ]; then
        whiptail --msgbox "/dev/root does not exist or is not a symlink. Don't know how to expand" 20 60 2
        return 0
    fi

    ROOT_PART=$(readlink /dev/root)
    PART_NUM=${ROOT_PART#mmcblk0p}
    if [ "$PART_NUM" = "$ROOT_PART" ]; then
        whiptail --msgbox "/dev/root is not an SD card. Don't know how to expand" 20 60 2
        return 0
    fi

    # NOTE: the NOOBS partition layout confuses parted. For now, let's only 
    # agree to work with a sufficiently simple partition layout
    if [ "$PART_NUM" -ne 2 ]; then
        whiptail --msgbox "Your partition layout is not currently supported by this tool. You are probably using NOOBS, in which case your root filesystem is already expanded anyway." 20 60 2
        return 0
    fi

    LAST_PART_NUM=$(parted /dev/mmcblk0 -ms unit s p | tail -n 1 | cut -f 1 -d:)

    if [ "$LAST_PART_NUM" != "$PART_NUM" ]; then
        whiptail --msgbox "/dev/root is not the last partition. Don't know how to expand" 20 60 2
        return 0
    fi

    # Get the starting offset of the root partition
    PART_START=$(parted /dev/mmcblk0 -ms unit s p | grep "^${PART_NUM}" | cut -f 2 -d:)
    [ "$PART_START" ] || return 1
    # Return value will likely be error for fdisk as it fails to reload the
    # partition table because the root fs is mounted
    fdisk /dev/mmcblk0 <<EOF
p
d
$PART_NUM
n
p
$PART_NUM
$PART_START

p
w
EOF
    ASK_TO_REBOOT=1

    # now set up an init.d script
cat <<\EOF > /etc/init.d/resize2fs_once &&
#!/bin/sh
### BEGIN INIT INFO
# Provides:          resize2fs_once
# Required-Start:
# Required-Stop:
# Default-Start: 2 3 4 5 S
# Default-Stop:
# Short-Description: Resize the root filesystem to fill partition
# Description:
### END INIT INFO

. /lib/lsb/init-functions

case "$1" in
    start)
        log_daemon_msg "Starting resize2fs_once" &&
        resize2fs /dev/root &&
        rm /etc/init.d/resize2fs_once &&
        update-rc.d resize2fs_once remove &&
        log_end_msg $?
        ;;
    *)
        echo "Usage: $0 start" >&2
        exit 3
        ;;
esac
EOF
    chmod +x /etc/init.d/resize2fs_once &&
    update-rc.d resize2fs_once defaults &&
    whiptail --msgbox "El tamaño de la partición raíz ha sido modificado.\nEl sistema de archivos se agrandará en el próximo reinicio." 20 60 2
}

do_finish() {
    # Cleanup backups
    [ -d /tmp/asterisk ] && rm -rf /tmp/asterisk

    # Disable setup at boot
    if [ -e /etc/profile.d/setup-asterisk.sh ]; then
        rm -f /etc/profile.d/setup-asterisk.sh
    fi

    if [ $ASK_TO_REBOOT -eq 1 ]; then
        whiptail --yesno "Debe reiniciar el equipo para poder aplicar la configuración.\n\n¿Desea reiniciar ahora?" 20 60 2
        if [ $? -eq 0 ]; then # yes
			if [ -n "${RASPBERRY_IP_ADDRESS}" ]; then
                whiptail --msgbox "La dirección IP tras el reinicio será ${RASPBERRY_IP_ADDRESS}" 20 60 1
            fi
            sync
            reboot
        fi
    fi
    exit 0
}

do_backups() {
    [ ! -f /etc/asterisk/sip.conf.orig ] && cp /etc/asterisk/sip.conf /etc/asterisk/sip.conf.orig
    [ ! -f /etc/asterisk/extensions.conf.orig ] && cp /etc/asterisk/extensions.conf /etc/asterisk/extensions.conf.orig
    [ ! -f /etc/asterisk/users.conf.orig ] && cp /etc/asterisk/users.conf /etc/asterisk/users.conf.orig

    [ ! -d /tmp/asterisk ] && mkdir -p /tmp/asterisk

    cp /etc/asterisk/sip.conf /tmp/asterisk/sip.conf
    cp /etc/asterisk/extensions.conf /tmp/asterisk/extensions.conf
    cp /etc/asterisk/users.conf /temp/asterisk/users.conf
}

do_restore_backups() {
    cp /tmp/asterisk/sip.conf /etc/asterisk/sip.conf
    cp /tmp/asterisk/extensions.conf /etc/asterisk/extensions.conf
    cp /temp/asterisk/users.conf /etc/asterisk/users.conf
}

do_set_userbase()
{
    local userbase=${ASTERISK_USERS_CONF_USERBASE}

    while true; do
        userbaser=$(whiptail --inputbox "Introduzca la primera extensión para los usuarios" 20 60 "${ASTERISK_USERS_CONF_USERBASE}" 3>&1 1>&2 2>&3)
        if [ $? -eq 0 ]; then
            if [[ $userbase =~ ^-?[0-9]+$ ]]; then
                ASTERISK_USERS_CONF_USERBASE=${userbase}
                CURRENT_EXTENSION_NUM=${userbase}
                return 0
            else
                whiptail --msgbox "La extensión debe ser un valor numérico." 20 60 1
            fi
        else
            return 1
        fi
    done
}

do_add_user() {
    local extension_fullname=''
    local extension_email=''
    local extension_password=''
    local extension_cid_number=''

    # 1001 está¡ reservado para el cliente del Comtrend VG-8050 via LAN
    if [ $CURRENT_EXTENSION_NUM -eq 1001 ]; then
        ((CURRENT_EXTENSION_NUM=CURRENT_EXTENSION_NUM+1))
    fi

    extension_cid_number=${CURRENT_EXTENSION_NUM}

    extension_password=$(whiptail --passwordbox "Introduzca la contraseña del usuario" 20 60 "" 3>&1 1>&2 2>&3)
    if [ $? -ne 0 ]; then
        return 1
    fi

    extension_fullname=$(whiptail --inputbox "Introduzca el nombre completo del usuario" 20 60 "" 3>&1 1>&2 2>&3)
    if [ $? -ne 0 ]; then
        extension_fullname=''
    fi
    
    extension_email=$(whiptail --inputbox "Introduzca el correo electrónico del usuario" 20 60 "" 3>&1 1>&2 2>&3)
    if [ $? -ne 0 ]; then
        extension_email=''
    fi

	whiptail --yesno "Por favor, revise los datos de la extensión.\n\n             Extensión: ${CURRENT_EXTENSION_NUM}\n       Nombre completo: ${extension_fullname}\n    Correo electrónico: ${extension_email}\n\n¿Desea continuar?" 20 60 2
    if [ $? -eq 0 ]; then # yes
        echo ""  >> /etc/asterisk/users.conf
        echo "[${extension_cid_number}]" >> /etc/asterisk/users.conf
        echo "host=dynamic" >> /etc/asterisk/users.conf
        echo "secret=${extension_password}" >> /etc/asterisk/users.conf
        if [ -n "${extension_fullname}" ]; then
            echo "fullname=${extension_fullname}" >> /etc/asterisk/users.conf
        fi
        if [ -n "${extension_email}" ]; then
            echo "email=${extension_email}" >> /etc/asterisk/users.conf
        fi
        echo "cid_number=${extension_cid_number}" >> /etc/asterisk/users.conf
    
        CONFIGURED_EXTENSIONS+=( "SIP/${CURRENT_EXTENSION_NUM}" )
        ((CURRENT_EXTENSION_NUM=CURRENT_EXTENSION_NUM+1))
	fi
}

do_movistar_ftth() {
    local sip_extensions=$( IFS=$'&'; echo "${CONFIGURED_EXTENSIONS[*]}" )
    
    PHONENUMBER=$(whiptail --inputbox "Introduzca su número de teléfono fijo" 20 60 "$CURRENT_HOSTNAME" 3>&1 1>&2 2>&3)
    if [ $? -ne 0 ]; then
        return 1
    fi
    
    whiptail --yesno "¿Desea establecer un PIN para las llamadas de tarificación adicional?" 20 60 2
    if [ $? -eq 0 ]; then # yes
        PIN_TARIFICACION_ADICIONAL=$(whiptail --passwordbox "Introduzca la contraseña del usuario" 20 60 "" 3>&1 1>&2 2>&3)
    fi
    
    # Configuracion para Movistar por SIP
    echo "" >> /etc/asterisk/sip.conf
    echo "[Movistar](!)" >> /etc/asterisk/sip.conf
    echo "type=peer" >> /etc/asterisk/sip.conf
    #echo "callerid=${PHONENUMBER}" >> /etc/asterisk/sip.conf
    #echo "host=telefonica.net" >> /etc/asterisk/sip.conf
    #echo "port=5060" >> /etc/asterisk/sip.conf
    #echo "from-domain=telefonica.net" >> /etc/asterisk/sip.conf
    #echo "fromuser=${PHONENUMBER}" >> /etc/asterisk/sip.conf
    echo "secret=${PHONENUMBER}" >> /etc/asterisk/sip.conf
    echo "dtmfmode=auto" >> /etc/asterisk/sip.conf
    echo "insecure=port,invite" >> /etc/asterisk/sip.conf
    echo "outboundproxy=10.31.255.134:5070" >> /etc/asterisk/sip.conf
    echo "nat=force_rport,comedia" >> /etc/asterisk/sip.conf
    #echo "trustrpid=yes" >> /etc/asterisk/sip.conf
    #echo "sendrpid=yes" >> /etc/asterisk/sip.conf
    echo "disallow=all" >> /etc/asterisk/sip.conf
    echo "allow=ulaw" >> /etc/asterisk/sip.conf
    echo "allow=alaw" >> /etc/asterisk/sip.conf
    #echo "context=from-movistar" >> /etc/asterisk/sip.conf
    
    echo "" >> /etc/asterisk/sip.conf
    echo "[MovistarOut](Movistar)" >> /etc/asterisk/sip.conf
    echo "host=telefonica.net" >> /etc/asterisk/sip.conf
    echo "from-domain=telefonica.net" >> /etc/asterisk/sip.conf
    echo "fromuser=${PHONENUMBER}" >> /etc/asterisk/sip.conf
    
    echo "" >> /etc/asterisk/sip.conf
    echo "[MovistarIn](Movistar)" >> /etc/asterisk/sip.conf
    echo "context=from-movistar" >> /etc/asterisk/sip.conf
    echo "defaultuser=${PHONENUMBER}" >> /etc/asterisk/sip.conf
    echo "host=10.31.255.134" >> /etc/asterisk/sip.conf
    echo "port=5060" >> /etc/asterisk/sip.conf
    echo "qualify=no" >> /etc/asterisk/sip.conf
    echo "trustpid=yes" >> /etc/asterisk/sip.conf
    
    sed -e "s|^;register => 2345:password@sip_proxy/1234|;register => 2345:password@sip_proxy/1234\nregister => ${PHONENUMBER}@telefonica.net:${PHONENUMBER}@10.31.255.134:5070|" -i /etc/asterisk/sip.conf

    echo "" >> /etc/asterisk/extensions.conf
    echo "[nacionales]" >> /etc/asterisk/extensions.conf
    echo "exten => _[89]ZXXXXXXX,1,Dial(SIP/MovistarOut/\${EXTEN})" >> /etc/asterisk/extensions.conf

    echo "" >> /etc/asterisk/extensions.conf
    echo "[moviles]" >> /etc/asterisk/extensions.conf
    echo "exten => _6XXXXXXXX,1,Dial(SIP/MovistarOut/\${EXTEN})" >> /etc/asterisk/extensions.conf
    echo "exten => _7[1234]XXXXXXX,1,Dial(SIP/MovistarOut/\${EXTEN})" >> /etc/asterisk/extensions.conf

    echo "" >> /etc/asterisk/extensions.conf
    echo "[numeros-inteligente-gratuitos]" >> /etc/asterisk/extensions.conf
    echo "exten => _[89]00XXXXXX,1,Dial(SIP/MovistarOut/\${EXTEN})" >> /etc/asterisk/extensions.conf

    echo "" >> /etc/asterisk/extensions.conf
    echo "[numeros-inteligente-precio-ordinario]" >> /etc/asterisk/extensions.conf
    echo "exten => _90[12]XXXXXX,1,Dial(SIP/MovistarOut/\${EXTEN})" >> /etc/asterisk/extensions.conf

    echo "" >> /etc/asterisk/extensions.conf
    echo "[numeros-inteligente-tarificacion-adicional]" >> /etc/asterisk/extensions.conf
    if [ -n "$PIN_TARIFICACION_ADICIONAL" ]; then
        echo "exten => _80[367]XXXXXX,1,Authenticate(${PIN_TARIFICACION_ADICIONAL})" >> /etc/asterisk/extensions.conf
        echo "exten => _80[367]XXXXXX,2,Dial(SIP/MovistarOut/\${EXTEN})" >> /etc/asterisk/extensions.conf
        echo "exten => _90[57]XXXXXX,1,Authenticate(${PIN_TARIFICACION_ADICIONAL})" >> /etc/asterisk/extensions.conf
        echo "exten => _90[57]XXXXXX,2,Dial(SIP/MovistarOut/\${EXTEN})" >> /etc/asterisk/extensions.conf
    else
        echo "exten => _80[367]XXXXXX,1,Dial(SIP/MovistarOut/\${EXTEN})" >> /etc/asterisk/extensions.conf
        echo "exten => _90[57]XXXXXX,1,Dial(SIP/MovistarOut/\${EXTEN})" >> /etc/asterisk/extensions.conf
    fi
    
    echo "" >> /etc/asterisk/extensions.conf
    echo "[numeros-inteligente-personales]" >> /etc/asterisk/extensions.conf
    echo "exten => _70XXXXXXX,1,Dial(SIP/MovistarOut/\${EXTEN})" >> /etc/asterisk/extensions.conf

    echo "" >> /etc/asterisk/extensions.conf
    echo "[numeros-inteligentes]" >> /etc/asterisk/extensions.conf
    echo "include => numeros-inteligente-gratuitos" >> /etc/asterisk/extensions.conf
    echo "include => numeros-inteligente-precio-ordinario" >> /etc/asterisk/extensions.conf
    echo "include => numeros-inteligente-tarificacion-adicional" >> /etc/asterisk/extensions.conf
    echo "include => numeros-inteligente-personales" >> /etc/asterisk/extensions.conf
    echo "; Fallback" >> /etc/asterisk/extensions.conf
    echo ";exten => _[89]0XXXXXXX,1,Dial(SIP/MovistarOut/\${EXTEN})" >> /etc/asterisk/extensions.conf

    echo "" >> /etc/asterisk/extensions.conf
    echo "[emergencias]" >> /etc/asterisk/extensions.conf
    echo "exten => 112,1,Dial(SIP/MovistarOut/112)" >> /etc/asterisk/extensions.conf
    echo "exten => 061,1,Dial(SIP/MovistarOut/061)" >> /etc/asterisk/extensions.conf
    echo "exten => 062,1,Dial(SIP/MovistarOut/062)" >> /etc/asterisk/extensions.conf
    echo "exten => 080,1,Dial(SIP/MovistarOut/080)" >> /etc/asterisk/extensions.conf
    echo "exten => 085,1,Dial(SIP/MovistarOut/085)" >> /etc/asterisk/extensions.conf
    echo "exten => 088,1,Dial(SIP/MovistarOut/088)" >> /etc/asterisk/extensions.conf
    echo "exten => 091,1,Dial(SIP/MovistarOut/091)" >> /etc/asterisk/extensions.conf
    echo "exten => 092,1,Dial(SIP/MovistarOut/092)" >> /etc/asterisk/extensions.conf
    echo "exten => 1006,1,Dial(SIP/MovistarOut/1006)" >> /etc/asterisk/extensions.conf

    echo "" >> /etc/asterisk/extensions.conf
    echo "[informacion-administrativa]" >> /etc/asterisk/extensions.conf
    echo "exten => 010,1,Dial(SIP/MovistarOut/010)" >> /etc/asterisk/extensions.conf
    echo "exten => 012,1,Dial(SIP/MovistarOut/012)" >> /etc/asterisk/extensions.conf
    echo "exten => 060,1,Dial(SIP/MovistarOut/060)" >> /etc/asterisk/extensions.conf

    echo "" >> /etc/asterisk/extensions.conf
    echo "[atencion-informacion-otros]" >> /etc/asterisk/extensions.conf
    echo "exten => 011,1,Dial(SIP/MovistarOut/011)" >> /etc/asterisk/extensions.conf
    echo "exten => 016,1,Dial(SIP/MovistarOut/016)" >> /etc/asterisk/extensions.conf
    echo "exten => 116XXX,1,Dial(SIP/MovistarOut/\${EXTEN})" >> /etc/asterisk/extensions.conf

    echo "" >> /etc/asterisk/extensions.conf
    echo "[consultas]" >> /etc/asterisk/extensions.conf
    echo "exten => _118XX,1,Dial(SIP/MovistarOut/\${EXTEN})" >> /etc/asterisk/extensions.conf

    echo "" >> /etc/asterisk/extensions.conf
    echo "[atencion-clientes]" >> /etc/asterisk/extensions.conf
    echo "exten => _1[34567]XX,1,Dial(SIP/MovistarOut/\${EXTEN})" >> /etc/asterisk/extensions.conf
    echo "exten => _[12]2XX,1,Dial(SIP/MovistarOut/\${EXTEN})" >> /etc/asterisk/extensions.conf

    echo "" >> /etc/asterisk/extensions.conf
    echo "[llamada-oculta]" >> /etc/asterisk/extensions.conf
    echo "exten => 069,1,Dial(SIP/MovistarOut/069)" >> /etc/asterisk/extensions.conf

    echo "" >> /etc/asterisk/extensions.conf
    echo ";[seleccion-operador]" >> /etc/asterisk/extensions.conf
    echo "; Códigos de selección de operador" >> /etc/asterisk/extensions.conf

    echo "" >> /etc/asterisk/extensions.conf
    echo "[numeros-cortos]" >> /etc/asterisk/extensions.conf
    echo "include => emergencias" >> /etc/asterisk/extensions.conf
    echo "include => informacion-administrativa" >> /etc/asterisk/extensions.conf
    echo "include => atencion-informacion-otros" >> /etc/asterisk/extensions.conf
    echo "include => consultas" >> /etc/asterisk/extensions.conf
    echo "include => atencion-clientes" >> /etc/asterisk/extensions.conf
    echo "include => llamada-oculta" >> /etc/asterisk/extensions.conf
    echo ";include => seleccion-operador" >> /etc/asterisk/extensions.conf

    echo "" >> /etc/asterisk/extensions.conf
    echo "[nomadas]" >> /etc/asterisk/extensions.conf
    echo "exten => _51XXXXXXXXX,1,Dial(SIP/MovistarOut/\${EXTEN})" >> /etc/asterisk/extensions.conf

    echo "" >> /etc/asterisk/extensions.conf
    echo "[internacionales]" >> /etc/asterisk/extensions.conf
    echo "exten => _00XXXXXX.,1,Dial(SIP/MovistarOut/\${EXTEN})" >> /etc/asterisk/extensions.conf

    echo "" >> /etc/asterisk/extensions.conf
    echo "[salientes]" >> /etc/asterisk/extensions.conf
    echo "include => nacionales" >> /etc/asterisk/extensions.conf
    echo "include => moviles" >> /etc/asterisk/extensions.conf
    echo "include => numeros-inteligentes" >> /etc/asterisk/extensions.conf
    echo "include => numeros-cortos" >> /etc/asterisk/extensions.conf
    echo "include => nomadas" >> /etc/asterisk/extensions.conf
    echo "include => internacionales" >> /etc/asterisk/extensions.conf

    echo "" >> /etc/asterisk/extensions.conf
    echo "[outbound-movistar]" >> /etc/asterisk/extensions.conf
    echo "include => nacionales" >> /etc/asterisk/extensions.conf
    echo "include => moviles" >> /etc/asterisk/extensions.conf
    echo "include => numeros-inteligentes" >> /etc/asterisk/extensions.conf
    echo "include => numeros-cortos" >> /etc/asterisk/extensions.conf
    echo "include => nomadas" >> /etc/asterisk/extensions.conf
    echo "include => internacionales" >> /etc/asterisk/extensions.conf
    echo "; Fallback" >> /etc/asterisk/extensions.conf
    echo ";exten => _X.,1,Dial(SIP/MovistarOut/\${EXTEN})" >> /etc/asterisk/extensions.conf
    
    echo "" >> /etc/asterisk/extensions.conf
    echo "[from-movistar]" >> /etc/asterisk/extensions.conf
    echo "exten => s,1,Dial(${sip_extensions})" >> /etc/asterisk/extensions.conf
    
    sed -e "s|^include => demo|include => outbound-movistar|" -i /etc/asterisk/extensions.conf
}

do_movistar_ftth_comtrend() {
    local sip_extensions=$( IFS=$'&'; echo "${CONFIGURED_EXTENSIONS[*]}" )

    # Envía los invites a 192.168.1.3
    dhcp_ip_address=$(ifconfig | grep -w inet |grep -v 127.0.0.1| awk '{print $2}' | cut -d ":" -f 2)
    dhcp_bcast_address=$(ifconfig | grep -w inet |grep -v 127.0.0.1| awk '{print $3}' | cut -d ":" -f 2)
    dhcp_netmask=$(ifconfig | grep -w inet |grep -v 127.0.0.1| awk '{print $4}' | cut -d ":" -f 2)
	dhcp_gateway=$(ip route | awk '/default/ { print $3 }')

    IFS=. read -r i1 i2 i3 i4 <<< "${dhcp_ip_address}"
	IFS=. read -r m1 m2 m3 m4 <<< "${dhcp_netmask}"
	dhcp_network=$(printf "%d.%d.%d.%d\n" "$((i1 & m1))" "$((i2 & m2))" "$((i3 & m3))" "$((i4 & m4))")
	RASPBERRY_IP_ADDRESS=$(echo ${dhcp_network} | awk -F. '$4=3' OFS=".")

    whiptail --yesno "Para que funcione el puerto FXS del Comtrend VG-8050 necesitamos configurar la dirección IP del Asterisk como ${RASPBERRY_IP_ADDRESS}.\n\n¿Desea continuar?" 20 60 2
    if [ $? -eq 0 ]; then # yes
        echo "auto lo" > /etc/network/interfaces
        echo "iface lo inet loopback" >> /etc/network/interfaces
        echo "" >> /etc/network/interfaces
        echo "iface eth0 inet static" >> /etc/network/interfaces
        echo "    address ${RASPBERRY_IP_ADDRESS}" >> /etc/network/interfaces
        echo "    netmask ${dhcp_netmask}" >> /etc/network/interfaces
        echo "    network ${dhcp_network}" >> /etc/network/interfaces
        echo "    broadcast ${dhcp_bcast_address}" >> /etc/network/interfaces
        echo "    gateway ${dhcp_gateway}" >> /etc/network/interfaces

	    echo "" >> /etc/asterisk/sip.conf
	    echo "[1001]" >> /etc/asterisk/sip.conf
	    echo "type=peer" >> /etc/asterisk/sip.conf
	    echo "secret=1001" >> /etc/asterisk/sip.conf
	    echo "host=dynamic" >> /etc/asterisk/sip.conf
	    echo "dtmfmode=inband" >> /etc/asterisk/sip.conf
	    echo "qualify=yes" >> /etc/asterisk/sip.conf
        echo "context=public" >> /etc/asterisk/sip.conf
        echo "disallow=all" >> /etc/asterisk/sip.conf
        echo "allow=ulaw" >> /etc/asterisk/sip.conf
	    echo "allow=alaw" >> /etc/asterisk/sip.conf
        echo "allow=gsm" >> /etc/asterisk/sip.conf
		echo "context=public" >> /etc/asterisk/sip.conf

        # Añadir la línea a las extensiones a llamar
		sed -e "s|,Dial(${sip_extensions})|,Dial(${sip_extensions}\&SIP/1001)|" -i /etc/asterisk/extensions.conf
        CONFIGURED_EXTENSIONS+=( "SIP/1001" )

        whiptail --msgbox "Recuerde que al reiniciar su nueva dirección IP será ${RASPBERRY_IP_ADDRESS}" 20 60 1
    else
        RASPBERRY_IP_ADDRESS=''
    fi
}

do_chan_dongle() {
    local sip_extensions=$( IFS=$'&'; echo "${CONFIGURED_EXTENSIONS[*]}" )
    
    MOBILE_PHONENUMBER=$(whiptail --inputbox "Introduzca el número de teléfono móvil del pincho" 20 60 "$CURRENT_HOSTNAME" 3>&1 1>&2 2>&3)
    if [ $? -ne 0 ]; then
        return 1
    fi

    sed -e "s|^noload => chan_dongle.so|load => chan_dongle.so|" -i /etc/asterisk/modules.conf
    sed -e "s|^exten=+1234567890|exten=${MOBILE_PHONENUMBER}|" -i /etc/asterisk/dongle.conf
    sed -e "s|^context=default|context=from-dongle|" -i /etc/asterisk/dongle.conf

    echo "" >> /etc/asterisk/extensions.conf
    echo "[from-dongle]" >> /etc/asterisk/extensions.conf

    # SMS
    echo "exten => sms,1,Verbose(Incoming SMS from \${CALLERID(num)} \${BASE64_DECODE(\${SMS_BASE64})})" >> /etc/asterisk/extensions.conf

    if [ -z "$DONGLE_EMAIL_ADDRESS" ]; then
        echo "exten => sms,n,Set(FILE(/var/log/asterisk/sms.log,,,a)=\${STRFTIME(\${EPOCH},,%Y-%m-%d %H:%M:%S)} - \${DONGLENAME} - \${CALLERID(num)}: \${BASE64_DECODE(\${SMS_BASE64})})" >> /etc/asterisk/extensions.conf
        echo "exten => sms,n,System(echo >> /var/log/asterisk/sms.log)" >> /etc/asterisk/extensions.conf
    else
        echo "exten => sms,n,System(echo \"To: $DONGLE_EMAIL_ADDRESS\nSubject: Incoming SMS from \${CALLERID(num)}\n\n\${STRFTIME(\${EPOCH},,%Y-%m-%d %H:%M:%S)} - \${DONGLENAME} - \${CALLERID(num)}: \" > /tmp/sms.txt)" >> /etc/asterisk/extensions.conf
        echo "exten => sms,n,Set(FILE(/tmp/sms.txt,,,a)=\${BASE64_DECODE(\${SMS_BASE64})})" >> /etc/asterisk/extensions.conf
        echo "exten => sms,n,System(sendmail -t < /tmp/sms.txt)" >> /etc/asterisk/extensions.conf
    fi

    if [ -n "$DONGLE_FORWARD_SMS_TO" ]; then
        echo "exten => sms,n,DongleSendSMS(dongle0,$DONGLE_FORWARD_SMS_TO,\${BASE64_DECODE(\${SMS_BASE64})} - from \${CALLERID(num)})" >> /etc/asterisk/extensions.conf
    fi

    echo "exten => sms,n,Hangup()" >> /etc/asterisk/extensions.conf

    # DISA
    whiptail --yesno "¿Desea habilitar DISA en el canal GSM?" 20 60 2 --yes-button Si --no-button No
    if [ $? -eq 0 ]; then
        DONGLE_DISA_PHONENUMBER=$(whiptail --inputbox "Introduzca el número de teléfono desde el que accederá a DISA" 20 60 "$CURRENT_HOSTNAME" 3>&1 1>&2 2>&3)
        if [ $? -ne 0 ]; then
            DONGLE_DISA_PHONENUMBER=''
        fi
        
        if [ -n $DONGLE_DISA_PHONENUMBER ]; then
            DONGLE_DISA_PIN=$(whiptail --passwordbox "Introduzca el PIN para acceder a DISA" 20 60 "$CURRENT_HOSTNAME" 3>&1 1>&2 2>&3)
            if [ $? -ne 0 ]; then
                DONGLE_DISA_PIN=''
            fi
            
            echo "exten => _.,1,GotoIf(\$[\"\${CALLERID(num)}\" = \"${DONGLE_DISA_PHONENUMBER}\"]?500)" >> /etc/asterisk/extensions.conf
        else
            whiptail --msgbox "DISA no ha sido activado." 20 60 1
        fi
    fi
    
    # All other incoming calls
    echo "exten => _.,10,Set(CALLERID(name)=\${CALLERID(num)})" >> /etc/asterisk/extensions.conf
    echo "exten => _.,11,Dial(${sip_extensions})" >> /etc/asterisk/extensions.conf
    
    if [ -n $DONGLE_DISA_PHONENUMBER ]; then
        echo "exten => _.,499,Hangup()" >> /etc/asterisk/extensions.conf
        echo "exten => _.,500,Answer()" >> /etc/asterisk/extensions.conf
        if [ -n $DONGLE_DISA_PIN ]; then
            echo "exten => _.,501,Authenticate(${DONGLE_DISA_PIN})" >> /etc/asterisk/extensions.conf
            echo "exten => _.,502,Background(vm-enter-num-to-call)" >> /etc/asterisk/extensions.conf
            echo "exten => _.,503,DISA(no-password, public)" >> /etc/asterisk/extensions.conf
        else
            echo "exten => _.,501,Background(vm-enter-num-to-call)" >> /etc/asterisk/extensions.conf
            echo "exten => _.,502,DISA(no-password, public)" >> /etc/asterisk/extensions.conf
        fi
    fi
}

if [ $(id -u) -ne 0 ]; then
    echo "This script must be run as root" 1>&2
    exit 1
fi

calc_wt_size

whiptail --msgbox "Bienvenido al instalador de Asterisk\n\nA continuación le guiaremos por el proceso de configuración del sistema y estará listo para utilizar su centralita Asterisk." 20 60 2

whiptail --yesno "¿Desea expandir el sistema para hacer uso de todo el disco duro?" 20 60 2 --yes-button Si --no-button No
if [ $? -eq 0 ]; then
    do_expand_rootfs
fi

# do_set_userbase

while true; do
    do_add_user

    whiptail --yesno "¿Desea agregar otro usuario?" 20 60 2 --yes-button Si --no-button No
    if [ $? -eq 1 ]; then
        break
    fi
done

do_movistar_ftth

whiptail --yesno "¿Desea configurar el Comtrend VG-8050 para utilizar los teléfonos analógicos?" 20 60 2 --yes-button Si --no-button No
if [ $? -eq 0 ]; then
    do_movistar_ftth_comtrend
fi


whiptail --yesno "¿Desea activar chan_dongle?" 20 60 2 --yes-button Si --no-button No
if [ $? -eq 0 ]; then
    do_chan_dongle
fi

do_finish
