#!/bin/bash

CURRENT_EXTENSION_ID=6000
TEMP_PATH='/tmp/asterisk'

do_user_add() {
	local extension_fullname=''
	local extension_email=''
	local extension_password=''
	local extension_password_confirm=''
	local extension_vmsecret=''
	local extension_vmsecret_confirm=''
	
	local whiptail_title="Nueva extensión: ${CURRENT_EXTENSION_ID}"
	
    while true; do
        extension_password=$(whiptail --title="${whiptail_title}" --passwordbox "Introduzca la contraseña de la extensión" 20 60 "" 3>&1 1>&2 2>&3)
        if [ $? -ne 0 ]; then
            return 1
        fi
    
        extension_password_confirm=$(whiptail --title="${whiptail_title}" --passwordbox "Vuelva a introducir la contraseña de la extensión" 20 60 "" 3>&1 1>&2 2>&3)
        if [ $? -ne 0 ]; then
            return 1
        fi
        
        if [ "${extension_password}" = "${extension_password_confirm}" ]; then
            break;
        else
            whiptail --title "Error" --msgbox "Las contraseñas no coinciden." 20 60 2
        fi
    done
	
	extension_fullname=$(whiptail --title="${whiptail_title}" --inputbox "Introduzca el nombre completo del usuario" 20 60 "" 3>&1 1>&2 2>&3)
    if [ $? -ne 0 ]; then
        extension_fullname=''
    fi
	
	extension_email=$(whiptail --title="${whiptail_title}" --inputbox "Introduzca el correo electrónico del usuario" 20 60 "" 3>&1 1>&2 2>&3)
    if [ $? -ne 0 ]; then
        extension_email=''
    fi
	
	whiptail --title="${whiptail_title}" --yesno "¿Desea activar el buzón de voz para ésta extensión?" 20 60 2
    if [ $? -eq 0 ]; then # yes
		while true; do
			extension_vmsecret=$(whiptail --title="${whiptail_title}" --passwordbox "Introduzca el código PIN para el buzón de voz" 20 60 "" 3>&1 1>&2 2>&3)
			if [ $? -ne 0 ]; then
				whiptail --title="${whiptail_title}" --yesno "¿Desea activar el buzón de voz para ésta extensión?" 20 60 2
				if [ $? -eq 0 ]; then # yes
					continue
				else
					break
				fi
			fi
    
			extension_vmsecret_confirm=$(whiptail --title="${whiptail_title}" --passwordbox "Vuelva a introducir el código PIN para el buzón de voz" 20 60 "" 3>&1 1>&2 2>&3)
			if [ $? -ne 0 ]; then
				extension_vmsecret=''
				whiptail --title="${whiptail_title}" --yesno "¿Desea activar el buzón de voz para ésta extensión?" 20 60 2
				if [ $? -eq 0 ]; then # yes
					continue
				else
					break
				fi
			fi
        
			if [ "${extension_vmsecret}" = "${extension_vmsecret_confirm}" ]; then
				break;
			else
				whiptail --title "Error" --msgbox "Las contraseñas no coinciden." 20 60 2
			fi
		done
	fi
	
	# Write to temp
	[ ! -d ${TEMP_PATH}/users.conf/ ] mkdir -p ${TEMP_PATH}/users.conf/
	[ -f ${TEMP_PATH}/users.conf/${CURRENT_EXTENSION_ID} ] rm ${TEMP_PATH}/users.conf/${CURRENT_EXTENSION_ID}
	
	touch ${TEMP_PATH}/users.conf/${CURRENT_EXTENSION_ID}
	
	if [ -n "${extension_fullname}" ]; then
        echo "fullname = ${extension_fullname}" >> ${TEMP_PATH}/users.conf/${CURRENT_EXTENSION_ID}
    fi
	
	if [ -n "${extension_email}" ]; then
        echo "email = ${extension_email}" >> ${TEMP_PATH}/users.conf/${CURRENT_EXTENSION_ID}
    fi
		
	echo "secret = ${extension_password}" >> ${TEMP_PATH}/users.conf/${CURRENT_EXTENSION_ID}
	
	if [ -n "${extension_vmsecret}" ]; then
        echo "hasvoicemail = yes" >> ${TEMP_PATH}/users.conf/${CURRENT_EXTENSION_ID}
		echo "vmsecret = ${extension_vmsecret}" >> ${TEMP_PATH}/users.conf/${CURRENT_EXTENSION_ID}
    fi
}

do_user_add